<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Add Prescription</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <style>
        .weekday { display:inline-block; margin-right:8px; }
        .error { color: #b00020; margin-bottom:8px; }
        .time-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    </style>
</head>
<body>
<div class="card">
    <h1>Add Prescription</h1>

    <div th:if="${errors != null}">
        <div th:each="e : ${errors.entrySet()}" class="error" th:text="${e.key + ': ' + e.value}"></div>
    </div>

    <form id="prescriptionForm" th:action="@{/prescriptions/new}" th:object="${prescription}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div class="form-group">
            <label for="medicineId">Medicine <span style="color:red">*</span></label>
            <select id="medicineId" name="medicineId">
                <option value="" disabled selected>Select medicine...</option>
                <option th:each="m : ${medicines}" th:value="${m.id}" th:text="${m.name}"></option>
            </select>
            <a class="btn" th:href="@{/medicines/new}">Add medicine</a>
            <div class="error" th:if="${errors != null}" th:text="${errors['medicine']}"></div>
        </div>

        <div class="form-group">
            <label>Week days <span style="color:red">*</span></label>
            <div>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Mon" /> Mon</label>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Tue" /> Tue</label>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Wed" /> Wed</label>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Thu" /> Thu</label>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Fri" /> Fri</label>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Sat" /> Sat</label>
                <label class="weekday"><input type="checkbox" class="weekday-box" value="Sun" /> Sun</label>
                <label class="weekday"><input type="checkbox" id="dailyToggle" /> Daily</label>
            </div>
            <input type="hidden" th:field="*{weekDays}" id="weekDaysHidden" />
            <div class="error" th:if="${errors != null}" th:text="${errors['weekDays']}"></div>
        </div>

        <!-- interval removed per user request -->

        <div class="form-group">
            <label>Day Times <small>(add one or more)</small></label>
            <div id="timesContainer">
                <div class="time-row">
                    <input type="time" name="dayTimes" />
                    <button type="button" class="btn" id="addTime">+</button>
                </div>
            </div>
            <div class="error" th:if="${errors != null}" th:text="${errors['dayTimes']}"></div>
        </div>

        <div class="form-group">
            <label>Dosage Amount <span style="color:red">*</span></label>
            <input type="number" step="0.001" th:field="*{dosageAmount}" />
            <div class="error" th:if="${errors != null}" th:text="${errors['dosageAmount']}"></div>
        </div>

        <div class="form-group">
            <label>Dosage Unit <span style="color:red">*</span></label>
            <input type="text" th:field="*{dosageUnit}" />
            <div class="error" th:if="${errors != null}" th:text="${errors['dosageUnit']}"></div>
        </div>

        <div class="form-group">
            <label>Start Date</label>
            <input type="date" th:field="*{startDate}" />
            <div class="error" th:if="${errors != null}" th:text="${errors['startDate']}"></div>
        </div>

        <div class="form-group">
            <label>End Date</label>
            <input type="date" th:field="*{endDate}" />
        </div>

        <div>
            <button class="btn" type="submit">Save Prescription</button>
            <a class="btn btn-secondary" th:href="@{/prescriptions/list}">Cancel</a>
        </div>
    </form>
</div>

<script>
    // helper to update hidden weekDays field from checkboxes
    function updateWeekDays() {
        const boxes = document.querySelectorAll('.weekday-box');
        const selected = Array.from(boxes).filter(b => b.checked).map(b => b.value);
        document.getElementById('weekDaysHidden').value = selected.join(',');
    }

    document.querySelectorAll('.weekday-box').forEach(b => b.addEventListener('change', () => {
        // if any unchecked, unset daily toggle
        if (!Array.from(document.querySelectorAll('.weekday-box')).every(x => x.checked)) {
            document.getElementById('dailyToggle').checked = false;
        }
        updateWeekDays();
    }));

    document.getElementById('dailyToggle').addEventListener('change', function() {
        const boxes = document.querySelectorAll('.weekday-box');
        boxes.forEach(b => b.checked = this.checked);
        updateWeekDays();
    });

    // dynamic time inputs
    document.getElementById('addTime').addEventListener('click', function() {
        const container = document.getElementById('timesContainer');
        const div = document.createElement('div');
        div.className = 'time-row';
        div.innerHTML = '<input type="time" name="dayTimes" /> <button type="button" class="btn removeTime">-</button>';
        container.appendChild(div);
        div.querySelector('.removeTime').addEventListener('click', () => div.remove());
    });

    // client-side validation on submit
    document.getElementById('prescriptionForm').addEventListener('submit', function(e) {
        updateWeekDays();
        const errors = [];
        if (!document.getElementById('medicineId').value) errors.push('Medicine is required');
        if (!document.getElementById('weekDaysHidden').value) errors.push('At least one week day is required');
        // interval value validation removed per user request
        if (!document.querySelector('input[th\\:field="*{dosageAmount}"]') && !document.querySelector('input[name="dosageAmount"]')) {
            // fallback check by model binding; skip
        }
        // dosage unit & start date validation are dealt with server-side as well
        if (errors.length) {
            e.preventDefault();
            alert(errors.join('\n'));
        }
    });
</script>
</body>
</html>
